name: Auto Merge PR

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: write
      contents: write
      statuses: read
      checks: read
    
    steps:
      - name: Approve PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            try {
              await github.rest.pulls.createReview({
                owner,
                repo,
                pull_number: prNumber,
                event: 'APPROVE'
              });
              console.log('PR approved successfully');
            } catch (error) {
              console.log('Approve result:', error.message);
            }

      - name: Enable auto-merge via API
        uses: actions/github-script@v7
        with:
          script: |
            const pullRequestId = context.payload.pull_request.node_id;
            
            const query = `
              mutation($pullRequestId: ID!) {
                enablePullRequestAutoMerge(input: {pullRequestId: $pullRequestId}) {
                  clientMutationId
                }
              }
            `;
            
            try {
              await github.graphql(query, { pullRequestId });
              console.log('Auto-merge enabled successfully');
            } catch (error) {
              console.log('Auto-merge enable result:', error.message);
            }

      - name: Wait for checks
        uses: actions/github-script@v7
        with:
          script: |
            // Wait up to 4 minutes for checks to complete
            for (let i = 0; i < 16; i++) {
              await new Promise(r => setTimeout(r, 15000));
              
              const prNumber = context.payload.pull_request.number;
              const owner = context.repo.owner;
              const repo = context.repo.repo;
              
              const pr = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: prNumber
              });
              
              // Check if ready: mergeable and either clean, has_hooks, or stable
              const state = pr.data.mergeable_state;
              if (pr.data.mergeable && (state === 'clean' || state === 'has_hooks' || state === 'stable' || state === 'unstable')) {
                console.log('Checks passed, ready to merge, state: ' + state);
                break;
              }
              console.log(`Waiting for checks... attempt ${i + 1}/16, state: ${state}`);
            }

      - name: Merge PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            const pr = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber
            });
            
            if (pr.data.mergeable && pr.data.state === 'open') {
              try {
                await github.rest.pulls.merge({
                  owner,
                  repo,
                  pull_number: prNumber,
                  merge_method: 'squash'
                });
                console.log('PR merged successfully');
              } catch (error) {
                console.log('Merge result:', error.message);
                
                // Try one more time after short wait
                await new Promise(r => setTimeout(r, 5000));
                try {
                  await github.rest.pulls.merge({
                    owner,
                    repo,
                    pull_number: prNumber,
                    merge_method: 'squash'
                  });
                  console.log('PR merged on second attempt');
                } catch (e) {
                  console.log('Second merge attempt failed:', e.message);
                }
              }
            } else {
              console.log('PR not ready for merge, state: ' + pr.data.mergeable_state);
            }
